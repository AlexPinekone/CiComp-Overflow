
# ======= (HTTP context) límites por IP =======
# Clave por cliente: IP binaria (eficiente y estable)
limit_req_zone $binary_remote_addr zone=api_per_ip:10m rate=5r/s;
# Opcional: limitar conexiones simultáneas por IP (no solo RPS)
limit_conn_zone $binary_remote_addr zone=conn_per_ip:10m;

# (Opcional) si prefieres 429 en vez de 503 al exceder:
limit_req_status 429;

server {
    listen 80 default_server;
    server_name _;

    # Host/puerto y proto originales (evita el mismatch con Next.js)
    proxy_set_header Host $http_host; # incluye :puerto
    proxy_set_header X-Forwarded-Host $http_host; # incluye :puerto
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # WebSockets/SSE (útil con Next.js)
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";


    
    # ---------- Solo /api/ con rate limit ----------
    location ^~ /api/ {
        # Límite: 10 req/seg por IP, con "burst" de 20.
        # - "burst 20": permite picos cortos sin rechazar inmediatamente
        # - "nodelay": se rechaza cuando se excede burst (sin encolado)
        limit_req zone=api_per_ip burst=20 nodelay;

        # (Opcional) limitar conexiones simultáneas por IP aquí:
        limit_conn conn_per_ip 20;

        # (Opcional) respuesta JSON para 429
        error_page 429 = @rate_limited;

        proxy_pass http://next-app:3000;
    }

    # Página de error 429 con JSON (opcional)
    location @rate_limited {
        add_header Content-Type application/json always;
        return 429 '{"error":"rate_limited","detail":"Too Many Requests"}';
    }

    location / {
        proxy_pass http://next-app:3000;
    }
}
